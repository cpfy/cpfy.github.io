计算机网络 笔记

ps：罗的ppt全是英文且杂乱，参考了刘秩的分章节

## 第一课 课程介绍

协议、架构、多样性，各种综述等

最终成绩：平时成绩10% + 期末考试成绩90%

平时成绩：课后作业及课堂考勤综合考评

## 第二课 网络概述

### T3

#### 分组/包（Packet）

packet：包括header、payload。即报文与报头

Packets are a chunk of bits with:

* Payload: meaningful only to the endpoints
* Header: meaningful to the network and endpoint



* Bandwidth: number of bits sent (or received) per unit time (bits/second or bps)
  “width” of the link
* Propagation delay: time it takes a bit to travel along the link (seconds)
  “length” of the link
* 时延带宽积：Bandwidth-Delay Product (BDP): bits/time x propagation delay (bits)
  “capacity” of the link

传输时延 Packet Delay = (Packet Size / Link Bandwidth) + Propagation Delay

#### 地址与命名

基本定义：

* Network address: where host is located
* Network name: which host it is

address与name，以及二者映射。此步骤由Domain Name System (DNS) 域名解析系统完成

#### 路由（routing）

* 控制面：计算转发表的机制。
  * 固有全局:必须知道拓扑结构以便于计算
  * Routing算法是控制面的一部分
  * 时间尺度:每个网络事件
* 数据平面：使用这些表实际转发包。
  * 固有本地:只依赖于到达包和本地路由表。
  * 转发机制是数据面的一部分
  * 时间尺度：每一个到达包

每个plane有相应的challenge

对于data plane，需要在10ns内完成以下任务：

* Parse packet (extract address, etc.)
* Look up address in forwarding table
* Update other fields in packet header (if needed)
* Update relevant internal counters, etc.
* Send packet to appropriate output link

#### 统计复用

统计复用：静态资源复用。如OS的CPU、云计算

具有假设：流的峰值小于峰值的和。peak of aggregate load is << aggregate of peak loads

【p30的一张图】

统计多路复用仅仅意味着您没有为绝对最坏的情况做准备。相反，你共享资源，并希望峰值率不会同时出现

两个复用的方法：

电路交换/分组交换

1. 预留，任意情况下都不能用。通过电路交换（circuit switching）【p35图介绍此方法】
2. best-effort方法。通过（packet switching）

为每个packet独立分配资源，路径？

##### 定义

* Circuit switching: resources shared between flows currently in system
  * Reserve the peak demand for a flow
  * But don’t reserve for all flows that might ever exist
* Packet switching: resources shared between packets currently in system
  * Resources given out on packet-by-packet basis
  * Never reserve resources

##### 效率比较

从应用角度看：

Circuits offer better application performance (reserved bandwidth)

More predictable and understandable (w/o failures)

Also a very intuitive abstraction in support of business models!

**Packet switching is typically more efficient**

后者处理“突发情况”，峰值等效果较好。

以应用程序的峰值传输速率与平均传输速率之间的比率为特征。有些应用的峰值与平均比率相对较小。语音应用的峰值与平均比率可能为3:1左右。数据应用程序往往是突发的。比率大于或等于100是常见的。这就是为什么电话网络使用预订而互联网不使用的原因!

四个评价维度：

* As an abstraction to applications (endhosts)
* Efficiency
* Handling failures
* Complexity of implementation

##### 优缺点

.电路开关的优点:。更好的应用性能(预留带宽)更容易预测和理解(无故障)。分组交换的优点:。更好的效率。更快的启动到第一个包交付。更简单的实现(避免了交换机中逐流的动态状态管理)

##### 瞬时过载

![image-20220307211654980](计算机网络 笔记.assets/image-20220307211654980.png)

p66的Transient Overload问题：处理方式，排队queue

加入queue后的时延

With queues: packet delay = transmission delay + propagation delay + queueing delay

#### 包的生命周期

* 源有一些数据要发送到目的地
* 将其分成若干个包:每个包都有一个有效负载和一个报头。
* 数据包沿着链路传输。
* 到达一个开关;交换机将数据包转发到下一跳。
  * 可能switch处有缓冲区，或丢弃
* 最后一步不断重复，直到我们到达目的地……
  * 或被丢弃、遗失

【挑战】拥塞控制（Congestion control），若深入了解，涉及复杂的 `排队论` 问题

本学期的话题：

* How do we name endhosts on the Internet? (naming)
* How do we address endhosts? (addressing)
* How do we map names to addresses? (mapping names to addresses)
* How do we compute forwarding tables? (routing control plane)
* How do we forward packets? (routing data plane)
* How do hosts communicate reliably? (reliable packet delivery)
* How do sources know at what rate they can send packets? (congestion control)
* How to download content efficiently  (HTTP and the web)

## 第三课 网络概述2

### 模块化

Modularity based on abstraction is the way things are done.	– Barbara Liskov, Turing lecture

* 将系统分解为更小的单元（提供“关注点分离”）
* 在计算机科学中扮演着至关重要的角色
* 关键在于找到正确的模块化

一个类比的例子：CEO_A寄快递给CEO_B

![image-20220309212813663](计算机网络 笔记.assets/image-20220309212813663.png)

相应将整个过程分为五段：

* **应用层**（L7）：Applications
* **传输层**（L4）：Reliable (or unreliable) data delivery
* **网络层**（L3）：Best-effort global packet delivery
* **数据链路层**（L2）：Best-effort local packet delivery
* **物理层**（L1）：Physical transfer of bits

事实上，在OSI的标准分类中共有7层，第5层Session会话层，第6层Presentation。但一般将其并入Application应用层。

### 协议

**不同系统的对等层（peer layers）之间的通信是由协议定义的。**

> 罗：标准化？——> 固有思维，好用就行，先实际用起来
> 对等的层之间才规定协议，协议双方是对等的层级。

协议指的是：

* 双方关于如何通信的协议
* 定义通信的**语法**
* 之后是**语义**概念（如：“首先是一个你好，然后是一个请求…”）
* 协议存在于许多级别，硬件和软件由各种标准组织(IETF, IEEE, ITU)定义。

#### 协议种类

![image-20220309214426403](计算机网络 笔记.assets/image-20220309214426403.png)

* 中间的网络层仅有一项协议 `IP` ，但其实是一系列协议组组成。
* 中间协议最少，两侧多，因此也被叫做酒杯模型、细腰模型
* 对每一层而言：依赖于下面的一层、支持上面的一层、独立于其他层
* 每层中的协议有多个版本：接口有所不同、组件选择使用哪个底层协议

### 传输过程

网络中的下面的三层可在任何地方实现（各个switch），上面的两层只在主机hosts上实现。

五层网络与设备对应关系：

![image-20220309214941517](计算机网络 笔记.assets/image-20220309214941517.png)

#### 端口（Port）

【Q】当收到一个包，如何知道是发给哪个应用的？通过端口号。

* 交换机/路由器有**物理端口**：链路连接到交换机的位置。
* 操作系统支持**逻辑端口**：应用程序连接到操作系统网络栈的位置

#### 套接字（Socket）

* Socket:一种连接应用程序进程到网络栈的操作系统机制
* 当一个应用程序想要访问网络时，它会打开一个套接字，这个套接字与一个端口相关联
* 该端口号被操作系统用来将传入的数据包导向其相关的套接字
* socket是通信真正的端点

示意图：

![image-20220309215334235](计算机网络 笔记.assets/image-20220309215334235.png)

#### 传输流程

![image-20220309215531218](计算机网络 笔记.assets/image-20220309215531218.png)

* 其中，routers之间的传输、routers与switch之间的同层次可采用不同协议（图中的SONET与Ethernet）

#### 报头

在传输时，数据包包含了多个报头：

![image-20220309215743781](计算机网络 笔记.assets/image-20220309215743781.png)

* 向底层运输时，在头部添加新的报头；向顶层解析时，去除报头信息。

### 传输可靠性

* 解决方案1使每个步骤可靠(需要网络来处理可靠性)
* 解决方案2:允许不可靠的步骤，但做端到端检查（end-to-end check），并在必要时重试（不假设网络是可靠的）

评估两种方案的优劣基于：正确性、性能两个方面

两个关于可靠性的想法：

1. 网络可以从故障中恢复，这样，只要有一条路径存在，两个端点就可以通信。
2. 网络故障不应干扰端点语义

第二个要求意味着我们必须采用解决方案2(不能依赖网络)。

#### 丢包率

![image-20220311165900763](计算机网络 笔记.assets/image-20220311165900763.png)



对于一个上图所示的从A到B的网络传输：

* 如果每条链路的丢包率为10%，我们有10条链路，那么端到端失败率（E2E failure rate）为 65 %
* 如果链路实现了两次重传怎么办?每条链路的丢包率降低到0.1%，端到端错误率为 1%

所以减少链路传输的丢包率可以大幅降低整体传输流程（现在的准确率都非常高，大概7个99%的量级？）

在网络中实现的可靠性功能：

* 不会降低主机实现的复杂性
* 会增加网络的复杂性
* 是否可以在所有应用程序上增加开销，即使它们不需要功能
* 然而，在网络中实现可以提高某些情况下的性能，如高损耗链路

#### 端到端原则

对该原则定义不一，有三种解释：

`Only-if-Sufficient` 解释

* 不要在系统的较低级别实现某个功能，除非它可以在这个级别完全实现
* 除非你能消除主机的负担，否则不要自找麻烦

`Only-if-Necessary` 解释

* 不要在网络中实现任何可以由主机正确实现的东西
* 使网络层绝对最小化
  * 这种端到端加密的解释胜过了性能问题
  * 增加灵活性，因为较低的层保持简单

`Only-if-Useful` 解释

* 如果主机能够正确地实现功能，那么在较低的层次上实现它只是为了提高性能
* 但是，只有当它不给不需要该功能的应用程序带来开销时，才会这样做
* 在决定在何处放置功能时，这个标准通常会严重地考虑性能

三种解释的评价：

![image-20220312101621320](计算机网络 笔记.assets/image-20220312101621320.png)

概括：

* 在哪里实现功能是不平凡的
  * 端到端原则塑造了我们如何思考权衡!
* 重要的是：记住这是论点（argument），而不是规则（rule）
  * 尽管每个人都同意可靠性应该主要在主机中实现

E2E原则忽略的内容：

* 除了用户，还有其他利益相关者
  isp关心他们网络的运营/安全，寻找新的创收功能
* 这些功能更容易在网络中实现，想想防火墙。
* 更简单，因为这是isp控制的!它们不控制主机，所以它是否能在主机中实现并不重要;它不会
* 入侵检测系统，负载均衡器，NAT…

#### Fate-Sharing 设计

* 在分布式系统中存储状态时，将其与依赖于该状态的实体放在一起
* 失败可能导致临界状态丢失的唯一方法是，如果关心临界状态的实体也失败了，在这种情况下，这并不重要
* 通常认为流状态应该保持在终端主机上，而不是在路由器内部。而不是电路交换

架构设计的智慧：

* 分层提供了一个清晰的关注点分离，因此**支持创新**！（协议可替代，更有竞争）
* 端到端原则将不必要的状态和功能排除在网络之外，因此**允许Internet扩展**！（其余功能留给终端做，从而实现“智能终端”）

> 以上是End to end 论文idea

### 网络设计目标

> Clark, D. (1988, August). The design philosophy of the DARPA Internet protocols. In Symposium proceedings on Communications architectures and protocols (pp. 106-114).

列出一堆设计目标：

1. Connect existing networks
2. Robust in face of failures
3. Support multiple types of delivery services  (I.e., multiple types of applications)
4. Accommodate a variety of networks
5. Allow distributed management of resources
6. Easy end host attachment
7. Cost effective
8. Allow resource accountability

相反：构建最低公分母服务！架构灵活性拒绝:可靠性，性能保证，认证，诊断，…

一些其他重要的因素：安全、隐私、可用性、资源共享、ISP层次关心因素（政策、经济效益、价值分配等）

## 第四课 ？

### 路由器 Router

多个节点通信，若两两连接，需要线太多，router减少网络连接与管理的复杂性

如何处理path？跳数最短并不一定时延最短

* Good的路径有多种衡量方式
* 不可有随机路径
* 不可把packet发给所有人



能够适应各种拓扑结构

一些美国国内、校园、企业、数据中心的网络拓扑结构举例



需要存储目的地表：（NextHop或Port格式）

| Dst  | NextHop | Port |
| ---- | ------- | ---- |
| A    | R1      | 0    |
| B    | R3      | 1    |
| C    | R3      | 1    |
| D    | R4      | 2    |

此方法叫基于目的的路由（destination-based routing/forwarding）



Routers做的事情：

* Forwarding：
  * 查表，发送包到邻居
  * 转发是本地的
  * data plane 负责
  * 时间尺度：每一个分组（ns单位）
* Routing
  * 与其他routers交流，决定如何为了forwarding计算表
  * Global的，必须知道全部目的地，不只是local
  * control plane的责任
  * 时间尺度：每个网络事件（network event），或每个 failure



一种Delivery Trees的方法

* NextHop变为一个指向相邻的箭头，所有箭头构成一棵树，以A为根节点

* 所有的路径构成有向Delivery tree
* （必须覆盖到全部节点

Routing State Validity

* 本地routing state是一个在单一router中的表（需要一种global类型的评估，不知道是否有效））
* 需要Global State，所有路由中的表的集合
* 路由协议的目的：计算valid state。也就是观察packets能否到达目的地

是valid当且仅当：无dead ends、无loops

* dead ends：死路，没有往外去的链接（next-hop）
* loops：循环，一个packet在一组同样的节点间重复流转

充分性：若无loops与dead ends，相当于有向非循环树，可证明是valid的

必要性：。。。



* Hosts总体上不参与路由。大多情况下，hosts有一个默认路由【？？？？】
* routers也可能是一个合法的目的地

验证有效性时

* 聚焦于一个目的地（忽略全部其它hosts与routing state）
* 2
* 移除未用到的links
* 观察是否是最小生成树？



距离矢量协议，设定的更新及连接方式：

每个router编号，获得一个magic number

之后给每个相邻的neighbour为自己的数加一，若数更小，更新num并指向新的router

一些可能导致错误的做法：忘记magic number、邻居未更新数字或连接、有人说谎







### 域间与域内路由

（Interdomain 与 Intradomain）

* Intradomain路由：或多或少意味着在单个网络内进行路由(技术上是一个“自治系统”)，所使用的协议通常被称为IGPs或内部网关协议
* Interdomain路由：网络间路由(ASes)，将许多网络绑定到Internet中的路由粘合剂。使用的协议称为EGPs或外部网关协议（External Gateway Protocols）

### 最小代价路由（Least-Cost Routing）

* 目标1：路由可行、有效（work）。不可有loop或dead ends
* 目标2：在某些方面“good”。最小化一些坏的因素如cost

代价可以指每一条边具有代价，寻找代价和最小的路径

另一种方式下，每一跳认为代价是1，即每条边代价1

最小代价：

* 是一个避免循环的简单方法
* 最小代价路由基于目的地的
* 形成一颗最小生成树



琐碎与静态路由

静态路由：通过操作者手工进入，多为特定目的

主机不参与路由协议

路由器不需知道主机在哪里？知道主机地址即可



距离向量协议

每隔X秒重新发送，X为间隔



Split Horizon & Counting to Infinity

水平分割

若某一路径断裂，避免导致loop。水平分割指从自己处学的路径避免告诉原路由

计数到无穷：循环时，hop计数无穷上升，解决方法为设定一个最大值停止，认为此事为无穷大、不可达



处理新增link的情况：

Nxt, Cost能够与原先相比后及时更新。特点：好消息传得快，坏的慢
