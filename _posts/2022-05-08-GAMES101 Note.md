From：

> https://www.bilibili.com/video/BV1X7411F744?spm_id_from=333.337.search-card.all.click

## L1 Overview

课程4个核心部分：

* Rasterization 光栅化
* Curves and meshes
* 光线追踪
* 动画/模拟

纠正一个认知，CG不等于OpenGL。

“实时”的定义指每秒可达到30帧，30FPS；否则叫“离线”（offline）



课程不包含的内容：

* OpenGL、DirectX、Vulcan
  * 因为这一类属于Graphics APIs，核心是讲背后的工作原理，API上手则容易。

* Maya、3DS MAX、Blender；Unity、Unreal Engine
  * 仍然是工具类，知其原理，运用不难
* CV/DL
  * 一切需要涉及猜测的指计算机视觉，需分析、理解、猜测

![image-20220317170719606](C:\Users\Admin\AppData\Roaming\Typora\typora-user-images\image-20220317170719606.png)

一种区分CV/CG的理解：

* CV：从一张图，识别出各种物体、结构
* CG：从模型生成图形

## L2 Review of Linear Algebra

基础数学线性代数，微积分，统计学，基础物理，力学，信号处理，数值分析和一点美学

### 向量

向量（矢量）：一些基础知识

#### 点乘

点乘：计算向量夹角。

* 图形学中应用如光照模型，计算法线、夹角；
* 两个向量投影的计算，可用于向量分解

#### 叉乘

泛定义：
$$
a\times b = -b\times a\\
||a\times b||=||a|| ||b||\sin\phi
$$
右手定则-方向：三指版本 or 螺旋版本 均可。

一般的右手坐标系下：
$$
\vec{x}\times \vec{y}=+\vec{z}\\
\vec{y}\times \vec{x}=-\vec{z}\\
$$
OpenGL等右手，DirectX、Unreal等左手

笛卡尔三维坐标系下：
$$
\vec{a}\times \vec{b}=
\begin{pmatrix}
y_az_b-y_bz_a\\
z_ax_b-x_az_b\\
x_ay_b-y_ax_b
\end{pmatrix}
$$
或写作：
$$
\vec{a}\times \vec{b}=A*b=
\begin{pmatrix}
0 & -z_a & y_a\\
z_a & 0 & -x_a\\
-y_a & x_a & 0
\end{pmatrix}
\begin{pmatrix}
x_b\\
y_b\\
z_b
\end{pmatrix}
$$
图形学中的应用：

* 判定左或右：比如为说明a左b右，用a叉乘b的结果为正即可说明
* 判定内或外：点P是否在三角形内？三角形ABC，AB叉乘AP、BC叉乘BP、CA叉乘CP若均为正，则立刻判断P在三角形内；否则在外

![image-20220317201240620](GAMES101 Note.assets/image-20220317201240620.png)

应用：如三角形光栅化时，判断每个像素是否在三角形内，并为之着色

#### 正交基与坐标系

单位向量u、v、w，直角坐标系计算投影等都很方便

### 矩阵

矩阵乘法、转置等概念。略

## L3 Transformation

### 2D变换

#### 缩放（Scale）

![image-20220330104628247](GAMES101 Note.assets/image-20220330104628247.png)

用矩阵乘法表示：
$$
\begin{bmatrix}
x'\\y'
\end{bmatrix}=
\begin{bmatrix}
s_x & 0\\0 & s_y
\end{bmatrix}
\begin{bmatrix}
x\\y
\end{bmatrix}
$$
其中，$x',y'$ 分别是变换后的x与y坐标，$s_x,s_y$ 为x与y方向上的缩放系数。

#### 切变（Shear）

![image-20220330115435268](GAMES101 Note.assets/image-20220330115435268.png)

* 水平方向上：
  * y=0处，偏移量为0；
  * y=1处，偏移量为a;
  * 总结出在y=t处，偏移量为at
* 竖直方向偏移恒为0

因此，矩阵变换形式为：
$$
\begin{bmatrix}
x'\\y'
\end{bmatrix}=
\begin{bmatrix}
1 & a\\0 & 1
\end{bmatrix}
\begin{bmatrix}
x\\y
\end{bmatrix}
$$

#### 旋转（Rotate）

逆时针转45度，记为 $R_{45}$。（默认沿原点+逆时针）

![image-20220330121352301](GAMES101 Note.assets/image-20220330121352301.png)
$$
R_\theta=
\begin{bmatrix}
\cos\theta & -\sin\theta\\
\sin\theta & \cos\theta
\end{bmatrix}
$$
通过找特殊点算出的系数A、B、C、D，弹幕指出还需证明此变换为线性变换。

### 齐次坐标

#### 引入

【Q】为什么引入齐次坐标？

【A】对于平移变换，无法写为与上述相近的一次矩阵乘法形式，不再是**线性变换**。但不希望把平移变换变为特殊变换，试图找到一种能包含全部变换的表示。
$$
\begin{cases}
x'=x+t_x\\
y'=y+t_y
\end{cases}
$$
只能表示为：
$$
\begin{bmatrix}
x'\\y'
\end{bmatrix}=
\begin{bmatrix}
a & b\\c & d
\end{bmatrix}
\begin{bmatrix}
x\\y
\end{bmatrix}+
\begin{bmatrix}
t_x\\t_y
\end{bmatrix}
$$

#### 内容

将二维坐标增加一个维度w

* 二维的**点**写为：$(x,y,1)^T$；
* 二维**向量**写为：$(x,y,0)^T$。

此时可用一次乘法（线性变换）表示平移变换；
$$
\begin{pmatrix}
x'\\y'\\w'
\end{pmatrix}=
\begin{pmatrix}
1 & 0 & t_x\\
0 & 1 & t_y\\
0 & 0 & 1
\end{pmatrix}\cdot
\begin{pmatrix}
x'\\y'\\1
\end{pmatrix}=
\begin{pmatrix}
x+t_x\\y+t_y\\1
\end{pmatrix}
$$
【Q】为何点与向量第三维w不同？

【A】因为向量具有平移不变特性，0可用于保护，矩阵乘法后不变。

另一种解释，代入1、0后，仍可保证加减操作正确：

* vector + vector = vector
* point - point = vector
* point + vector = vector
* point + point = ？（参考以下补充定义，可认为表示的是这两个点的中点，仍为point）

根据一个扩充定义，在齐次坐标系下，此二者等价：
$$
\begin{pmatrix}
x\\y\\w
\end{pmatrix}=
\begin{pmatrix}
x/w\\y/w\\1
\end{pmatrix}
$$

#### 仿射变换

用一种变换表示所有情况（Affine Transformation）。

注释：$\mathbf{S}$ 指缩放（scale），$\mathbf{R}$ 指旋转（Rotation），$\mathbf{T}$ 指平移（Translation）
$$
\mathbf{S}(s_x,s_y)=
\begin{pmatrix}
s_x & 0 & 0\\
0 & s_y & 0\\
0 & 0 & 1
\end{pmatrix}\\

\mathbf{R}(\alpha)=
\begin{pmatrix}
\cos\alpha & -\sin\alpha & 0\\
\sin\alpha & \cos\alpha & 0\\
0 & 0 & 1
\end{pmatrix}\\

\mathbf{T}(t_x,t_y)=
\begin{pmatrix}
1 & 0 & t_x\\
0 & 1 & t_y\\
0 & 0 & 1
\end{pmatrix}
$$

#### 逆变换

指将图像的变换操作逆回去，对应的即为变换矩阵的逆 $M^{-1}$

### 组合变换

复杂变换拆分为基本变换的组合，每一步左乘新的变换矩阵，不满足交换律。
$$
R_{45}\cdot T_{(1,0)}\neq T_{(1,0)}\cdot R_{45}
$$
可以表示为：
$$
A_n(...A_2(A_1(x)))=
\mathbf{A}_n\cdot\cdot\cdot\mathbf{A}_2\cdot \mathbf{A}_1\cdot
\begin{pmatrix}
x\\y\\1
\end{pmatrix}
$$
其中，由交换律，左侧的多个矩阵乘法可提前进行，因此简单的3*3矩阵可表示非常复杂的变换。

#### 绕非原点的旋转

![image-20220330171649132](GAMES101 Note.assets/image-20220330171649132.png)

步骤：

1. 移动到原点；
2. 旋转；
3. 移动回去

矩阵乘法表示：
$$
\mathbf{T}(c)\cdot \mathbf{R}(\alpha)\cdot \mathbf{T}(-c)
$$

### 3D变换

类比二维，多引入一维w，使用4*4的矩阵作为仿射变换

* 三维的**点**写为：$(x,y,z,1)^T$；
* 三维**向量**写为：$(x,y,z,0)^T$。

$$
\begin{pmatrix}
x'\\y'\\z'\\w'
\end{pmatrix}=
\begin{pmatrix}
a & b & c & t_x\\
d & e & f & t_y\\
g & h & i & t_z\\
0 & 0 & 0 & 1
\end{pmatrix}\cdot
\begin{pmatrix}
x\\y\\z\\1
\end{pmatrix}
$$

## L4 Transformation Cont.

### 3D变换

#### 缩放

$$
\mathbf{S}(s_x,s_y,s_z)=
\begin{pmatrix}
s_x & 0 & 0 & 0\\
0 & s_y & 0 & 0\\
0 & 0 & s_z & 0\\
0 & 0 & 0 & 1
\end{pmatrix}
$$

#### 平移

$$
\mathbf{T}(t_x,t_y,t_z)=
\begin{pmatrix}
1 & 0 & 0 & t_x\\
0 & 1 & 0 & t_y\\
0 & 0 & 1 & t_z\\
0 & 0 & 0 & 1
\end{pmatrix}
$$

#### 旋转

##### 特殊的绕轴旋转

绕x轴旋转，x不变，y和z是二维情况
$$
\mathbf{R}_x(\alpha)=
\begin{pmatrix}
1 & 0 & 0 & 0\\
0 & \cos\alpha & -\sin\alpha & 0\\
0 & \sin\alpha & \cos\alpha & 0\\
0 & 0 & 0 & 1
\end{pmatrix}
$$
**注意！**绕y轴此处的系数是反的！

无论左右手系都会特殊，这是由于 $z\times x=y$ ，并非与其他相同的如 $x\times y=z$
$$
\mathbf{R}_y(\alpha)=
\begin{pmatrix}
\cos\alpha & 0 & \sin\alpha & 0\\
0 & 1 & 0 & 0\\
-\sin\alpha & 0 & \cos\alpha & 0\\
0 & 0 & 0 & 1
\end{pmatrix}
$$
绕z轴旋转，是正常的
$$
\mathbf{R}_z(\alpha)=
\begin{pmatrix}
\cos\alpha & -\sin\alpha & 0 & 0\\
\sin\alpha & \cos\alpha & 0 & 0\\
0 & 0 & 1 & 0\\
0 & 0 & 0 & 1
\end{pmatrix}
$$

##### 任意旋转

被称为欧拉角（Euler Angle）的角度分解，类似飞机的roll、pitch、yaw三轴旋转
$$
\mathbf{R}_{xyz}(\alpha,\beta,\gamma)=
\mathbf{R}_x(\alpha)\cdot
\mathbf{R}_y(\beta)\cdot
\mathbf{R}_z(\gamma)
$$

##### Rodrigues 旋转公式

绕 **n** 轴（认为这个轴过原点）旋转 $\alpha$ 角公式为：
$$
\mathbf{R}(n,\alpha)=\cos(\alpha)\ \mathbf{I}+
(1-\cos(\alpha))\ \bf{n}\bf{n}^T+\sin(\alpha)
\begin{pmatrix}
0 & -n_z & -n_y \\
n_z & 0 & -n_x \\
-n_y & n_x & 1 
\end{pmatrix}
$$
注意：

* 若绕不过原点的任意轴，仍采用平移+旋转+平移回去 的矩阵乘法
* 后面的大矩阵与叉乘相关，将叉乘写作矩阵形式
* 四元数的概念：为表示旋转的插值引入，此处不涉及

### Viewing（观测） 变换

以照相类比

* 找到一个好地方，安排好人员（**model transformation**）
* 找到一个好的 "角度 "来放置摄像机（**view transformation**）
* Cheese！（**projection** trasformation）

取首字母，合称为“MVP”变换

#### 视图变换

##### 定义相机

* 位置 $\vec{e}$
* 往某个方向看 $\hat{g}$
* 向上方向，也就是旋转后方向会被歪过来（如插一根草） $\hat{t}$

<img src="GAMES101 Note.assets/image-20220413103153840.png" alt="image-20220413103153840" style="zoom: 80%;" />

##### 固定相机

但既然相机与物体在一起移动，拍出的照片是相同的，固定相机

* 约定：相机位于原点(0,0,0)，up方向是Y轴，look方向是-Z轴

如何从原状态（$\vec{e},\hat{t},\hat{g}$）移动到标准相机？通过 $M_{view}$ 变换

* e移动到原点
* g旋转到-Z轴
* t旋转到Y轴
* g×t旋转到X轴
* 若一一对应的话，很难写！

##### M视图变换

写为旋转R与平移T的矩阵乘法（先平移，后旋转）：$M_{view}=R_{view}T_{view}$

易知，T变换好写
$$
T_{view}=
\begin{bmatrix}
1 & 0 & 0 & -x_e\\
0 & 1 & 0 & -y_e\\
0 & 0 & 1 & -z_e\\
0 & 0 & 0 & 1
\end{bmatrix}
$$
R变换则很复杂，但是从原点到（$\vec{e},\hat{t},\hat{g}$）的 $R_{view}$ 的逆变换则很容易表示：
$$
R_{view}^{-1}=
\begin{bmatrix}
x_{\hat{g}\times\hat{t}} & x_t & x_{-g} & 0 \\
y_{\hat{g}\times\hat{t}} & y_t & y_{-g} & 0 \\
z_{\hat{g}\times\hat{t}} & z_t & z_{-g} & 0 \\
0 & 0 & 0 & 1
\end{bmatrix}
$$
考察对几个点应用该矩阵变换

* X轴上的(1,0,0,0)，对应得到的xyz就是第一列
* Y轴上的(0,1,0,0)，第二列
* ...

$$
R_{view}=
\begin{bmatrix}
x_{\hat{g}\times\hat{t}} & y_{\hat{g}\times\hat{t}} & z_{\hat{g}\times\hat{t}} & 0 \\
x_t & y_t & z_t & 0 \\
x_{-g} & y_{-g} & z_{-g} & 0 \\
0 & 0 & 0 & 1
\end{bmatrix}
$$

**因为旋转矩阵是正交矩阵！**因此它的转置就是逆，即 $R^{-1}=R^T$

模型、视图变换一般合称 ModelView Transformation

#### 投影变换

* 正交：平行线仍保持平行。不会有“近大远小”
* 透视：不再平行，有“近大远小”，延长后相交于一点

<img src="GAMES101 Note.assets/image-20220413110316601.png" alt="image-20220413110316601" style="zoom:80%;" />

* 正交可认为是相机在无限远

##### 正交投影（Orthographic）

一个简单描述：直接把Z坐标扔掉，平移并缩放到 $[-1,1]^2$ 区域

先定义一个立方体：$[l,r]\times[b,t]\times[f,n]$ ，希望将其变换到标准立方体 $[-1,1]^3$

<img src="GAMES101 Note.assets/image-20220413110901035.png" alt="image-20220413110901035" style="zoom:80%;" />

需要做R、T变换
$$
M_{ortho}=
\begin{bmatrix}
\frac{2}{r-l} & 0 & 0 & 0\\
0 & \frac{2}{t-b} & 0 & 0\\
0 & 0 & \frac{2}{n-f} & 0\\
0 & 0 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
1 & 0 & 0 & -\frac{r+l}{2}\\
0 & 1 & 0 & -\frac{t+b}{2}\\
0 & 0 & 1 & -\frac{n+f}{2}\\
0 & 0 & 0 & 1
\end{bmatrix}
$$
注意

* 沿着-Z看，会使近和远变得不直观（n>f），也就是“近小远大”
* 参考：这就是为什么OpenGL使用右手系

##### 透视投影（Perspective）

最广泛；满足近大远小性质；平行线不再平行（由于投影到另一平面上）

回顾齐次坐标：

* (x,y,z,1)、(kx,ky,kz,k!=0)、(xz,yz,z^2,z^2!=0)表示的都是同一个点
* (1,0,0,1)、(2,0,0,2)也都表示同一点(1,0,0)

透视投影要做的事情是沿着线投影，拆成两步：先把Frustum“挤”为长方体，再做正交投影。

<img src="GAMES101 Note.assets/image-20220413112812267.png" alt="image-20220413112812267" style="zoom:80%;" />

* 规定挤完后z值仍为n、f，值不变
* 规定远平面的中心点不会变化，挤压后仍为中心点
* 目前要求一个从透视到正交的变换 $M_{persp\to ortho}$

##### 挤压变换

<img src="GAMES101 Note.assets/image-20220413113533568.png" alt="image-20220413113533568" style="zoom:80%;" />

* 挤压后，点 $(x,y,z)$ 的高度会变为与 $(x',y',z')$ 相同，$y$ 变为 $y'$ ，二者是相似三角形的关系
* 类似，x‘ 的坐标也满足与x之间的 n/z 的比例关系

在齐次坐标系下，(x,y,z,1)坐标如下变换（此处z未知是因为只知道近平面、远平面z不变，其它平面的z可能变化）
$$
\begin{pmatrix}
x\\ y\\ z\\ 1
\end{pmatrix}\Rightarrow
\begin{pmatrix}
nx/z\\ ny/z\\ \text{unknown}\\ 1
\end{pmatrix}==
\begin{pmatrix}
nx\\ ny\\ \text{still unknown}\\ z
\end{pmatrix}
$$
从透视到正交的变换 $M_{persp\to ortho}$ 作用于此坐标导致上述变换，因此可求出M一部分的值
$$
M_{persp\to ortho}=
\begin{pmatrix}
n & 0 & 0 & 0\\
0 & n & 0 & 0\\
? & ? & ? & ?\\
0 & 0 & 1 & 0
\end{pmatrix}
$$

* **注意！**这里第4行为0010，不是常见的0001

观察到：近平面上的任何点的Z都不会变 + 远处平面上的任何点的Z都不会变。一个近平面上的点一定会映射到自己，故将z改写为n
$$
\begin{pmatrix}
x\\ y\\ n\\ 1
\end{pmatrix}\Rightarrow
\begin{pmatrix}
x\\ y\\ n\\ 1
\end{pmatrix}==
\begin{pmatrix}
nx\\ ny\\ n^2\\ n
\end{pmatrix}
$$
因此，M的第三行形式为
$$
\begin{pmatrix}
0 & 0 & A & B
\end{pmatrix}
\begin{pmatrix}
x\\ y\\ n\\ 1
\end{pmatrix}=n^2
$$
取远平面的中心点 $(0\quad 0\quad f\quad 1)$ ，也映射到自己（最后的第四个数是因为z=f）
$$
\begin{pmatrix}
0\\ 0\\ f\\ 1
\end{pmatrix}\Rightarrow
\begin{pmatrix}
0\\ 0\\ f\\ 1
\end{pmatrix}==
\begin{pmatrix}
0\\ 0\\ f^2\\ f
\end{pmatrix}
$$
因此，M的第三行形式为
$$
\begin{pmatrix}
0 & 0 & A & B
\end{pmatrix}
\begin{pmatrix}
0\\ 0\\ f\\ 1
\end{pmatrix}=f^2
$$
联立，可解得
$$
\begin{cases}
An+B=n^2\\
Af+B=f^2
\end{cases}\Longrightarrow
\begin{cases}
A=n+f\\
B=-nf
\end{cases}
$$
最终的透视投影表达式为：
$$
M_{persp}=M_{ortho}M_{persp\to ortho}
$$

## L5





参考资料

